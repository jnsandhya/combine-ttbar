
##   Combine tools for ttbar Lorentz analysis

This repository contains a set of scripts to call Combine tool to produce ttbar Lorentz analysis results.

# Install Combine

See https://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/

Choose version CC7 with CMSSW_10_2_13

On the CMSSW_10_2_13/src directory:

    > bash <(curl -s https://raw.githubusercontent.com/cms-analysis/CombineHarvester/master/CombineTools/scripts/sparse-checkout-https.sh)

On lyoui machines:

    > cms_env
    > cmsenv

Compile with scramv1 b.

# Installation :

In your terminal type following commands: 

    > git clone https://github.com/nchanon/combine-ttbar.git

The up-to-date directories are: inclusive, one_bin and sme. Unrolled is not used anymore. 

At first installation, a few directories need to be created:

    > source createDir.sh

The inputs are generated by PyPlotFramework (PPFv2, see https://github.com/nchanon/PPFv2).  
PPFv2 has a script (combine_export) to export the inputs for combine, stored for instance in:

inclusive/inputs/'year' directory

# Inclusive analysis

As an example, running the full time-integrated analysis using the observable n_bjets requires the following.

    > cd inclusive

First create the workspaces:

    > python scripts/workspace_creator.py n_bjets 2016
    > python scripts/workspace_creator.py n_bjets 2017

Make the combined workspace:

    > python scripts/combine_years.py n_bjets

Then perform the inclusive fits (providing stat+syst breakdown) for each year, on asimov and data:

    > python scripts/uncertainty_breakdown.py n_bjets

Make the impact plots:

    > python scripts/impacts.py n_bjets 2016 asimov
    > python scripts/impacts.py n_bjets 2017 asimov
    > python scripts/impacts.py n_bjets Comb asimov
    > python scripts/impacts.py n_bjets 2016 data
    > python scripts/impacts.py n_bjets 2017 data
    > python scripts/impacts.py n_bjets Comb data

Make the pre-fit (showing data/mc comparison with uncertainty band) and post-fit plots:

    > python scripts/prepostfit_plots.py n_bjets 2016 asimov "number of b-jets"
    > python scripts/prepostfit_plots.py n_bjets 2017 asimov "number of b-jets"

In python scripts/prepostfit_plots.py, combine must be run. 
There is an option to not running, if willing to adjust the plots.
Also, the pre-fit and post-fit options can be set by editing the script.


Make the goodness-of-fit tests (take some time, because it is running 500 toys each):

    > python scripts/goodnessoffit.py n_bjets 2016
    > python scripts/goodnessoffit.py n_bjets 2017
    > python scripts/goodnessoffit.py n_bjets Comb

In scripts/goodnessoffit.py, combine must be run. There is an option to not run it, if willing to adjust the plots.


# Differential analysis 

    > cd one_bin

To Generate the workspace : 
    
    > python scripts/workspace_multiSignalModel.py 'observable' 'year'

a workspace will be created in 'inputs' directory. 

To launch MultiDimFit methode 

    > scripts/launch_multidimfit.py 'workspace' 'asimov'

Type 'asimov' as second argument to get an asimov test run of combine.

    exemple :

    > scripts/launch_multidimfit.py inputs/combine_m_dilep_24bins_2017_workspace.root asimov

For impacts : 

    > scripts/uncorrelated_impacts.py 'observable' 'year' 'asimov'

The impact output is in the root directory

# c_munu fit

    > cd sme

Create the workspace with the good physics model :

    > python scripts/workspace_creator.py 'observable' 'year' 'wilson'

The wilson coefficient is ssomething like "cLXX, dXY, ... etc" 

To make the fit : 

    > python scripts/fit_alone.py 'observable' 'year' 'wilson' 'asimov'

exemple : 

    > python scripts/fit_alone.py m_dilep 2016 cLXX asimov

For impacts : 

    > python scripts/impacts.py m_dilep 2016 cLXX asimov

Impacts plots are stored in 'impacts' directory 



